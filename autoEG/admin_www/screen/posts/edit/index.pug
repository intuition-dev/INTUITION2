extends /layout/layout_edit

block main
	script.
		//Edit only: query for item 
		depp.require(['ma-client', 'login'], function() {
			console.log('user is logged in, will get data')
			let qs = window.location.search
			if (qs && qs.indexOf('?')==0)
			{
				window.aSrv.getItem(qs).then(function(resp) {
					data = resp.data._cmd
					depp.done('data')
				})
			}
			else alert('Query string missing')
		})

	p
	#edittitlep.container
		.form-group
			input.form-input(name='title', id='title', placeholder='Blog Title')
			input(name='url', id='url', type='hidden')
	p
	#editorp.container
		editor-tag

//- properties panel is in /layout/layout_edit.pug

block script
	script.
		const editor = riot.mount('editor-tag')[0] // mount the first tag
		const itag = riot.mount('featuredimage-tag')[0]
		const tag = riot.mount('medialist-tag')[0] 

		function deleteMedia(filename){
			$('#fx').val('')
			tag.deleteItem(filename)
		}

		depp.require(['style','ma-client'], function () {

			//tag.render() //empty list
			//editor.render('## Blog Entry here\n\n\n\n') //default
			editor.render()

			$('#title').keyup(function(){
				if(this.value.trim()) {
					$('.save').removeClass('disabled2')
				} else {
					$('.save').addClass('disabled2')
				}
			})

			$('#fx').change(function(){ //upload media
				tag.upload(this.files)
			}) 

			$('.save').click(function(){
				if ($(this).hasClass('disabled2') //validation
					|| editor.text()=='## Blog Entry here'
				) { 
					showError("You haven't written anything yet!")
					return
				}
				itag.read(readDone)
			})// click
		})//require

		function readDone(f1data, f1name) {
			let title = $('#title').val()
			let url = $('#url').val()
			let content = editor.text()
			content.replace('## Blog Entry here', '') //just in case it's left over

			let tags  = $('#tags').val()

			//TODO: handle
			let date_published = moment().toISOString()
			let date1 = $('#date1').val()
			if (date1 != '')
				date_published = moment(date1, 'D MMMM YYYY').toISOString()
			
			let fx = JSON.stringify(tag.items)

			window.aSrv.updateItem('blog/'+url, title, 'No summary', content, date_published, 
				tags, f1name, f1data, fx
			).then(newBlogRes)
			.catch(errorRes)
		}

		function newBlogRes(resp) {
			showSuccess('Blog entry saved successfully!', function(){
				window.location.href='/screen/posts'
			})
		}
		function errorRes(resp) {
			showError('Error'+resp.message)
		}

		depp.require(['style','data'], function () {
			alert(JSON.stringify(data))
			$('#title').val(data.title)
			$('#url').val(data.url) //the folder for the item
			$('#tags').val(data.tags)
			//TODO: enhance date published
			let d = moment(data.date_published, 'YYYY-MM-DDTHH:mm:ss.sssZ').format('D MMMM YYYY') 
			if (data.date_published)
				picker.pickadate('set').set('select', d, { format: 'D MMMM YYYY' })

			let abs_path = '#{PROD_ROOT}/blog/'+data.url
			// Featured image
			if (data.image) //src
			{
				if (data.image.indexOf('//')>-1) //external URL
					itag.setSrc(data.image)
				else
					itag.setSrc(abs_path+'/'+data.image)
			}
			//Media
			tag.render(data.media, abs_path)
			//Editor
			editor.text(data.content)
		})//require 


		

		







