/*
 * Lenticular
 * http://lenticular.attasi.com
 *
 * Licensed under the MIT license.
 * Copyright 2012 Tom Giannattasio
 */

var Lenticular={version:"0.3",images:[],axisTable:{landscape:{x:"gamma",y:"beta",z:"alpha"},portrait:{x:"beta",y:"gamma",z:"alpha"}},clamp:function(c,b,a){if(c>a){return a}if(c<b){return b}return c},updateFrames:function(f){for(var a in Lenticular.images){var d=Lenticular.images[a];if(!d.isActive){return}var b=Lenticular.axisTable[Lenticular.orientation][d.axis];var g=f[b];var c=Lenticular.clamp((g-d.adjustedMin)/d.tiltRange,0,1);d.showFrame(Math.floor(c*(d.frames-1)))}},updateOrientation:function(c){Lenticular.orientation=window.orientation==0?"portrait":"landscape";for(var a in Lenticular.images){var b=Lenticular.images[a];b.adjustedMin=b.minTilt;if(b.axis=="x"){b.adjustedMin=window.orientation==90?b.adjustedMin-45:b.vadjustedMin+45}}}};Lenticular.Image=function(d,f){var b=this;this.element=d;this.axis=f.axis||"y";this.images=f.images||null;this.frames=f.frames;this.minTilt=f.min||-10;this.maxTilt=f.max||10;this.isActive=f.isActive===false?false:true;this.tiltRange=this.maxTilt-this.minTilt;this.useTilt=f.useTilt===false?false:true;var e=this.images.split("##");this.imagePrefix=e[0];this.imageSuffix=e[1];Lenticular.images.push(this);this.imageSet=document.createElement("div");this.imageSet.setAttribute("class","lenticular-set");this.imageSet.style.cssText="position: relative; width: 100%; height: 100%; overflow: hidden;";this.imageSet.frames=[];var a=[];var h=setInterval(function(){var j=true;for(var i in a){if(a[i].isLoaded===false){j=false;break}}if(a.length==b.frames&&j){clearInterval(h);b.element.dispatchEvent(new Event("load"))}},100);for(var c=1;c<=this.frames;c++){var g=document.createElement("img");g.isLoaded=false;g.index=c;a.push(g);g.addEventListener("error",function(){this.isLoaded=true;b.frames--;a.splice(a.indexOf(this),1)},false);g.addEventListener("load",function(){this.isLoaded=true},false);g.setAttribute("src",this.imagePrefix+c+this.imageSuffix);g.style.cssText="position: absolute; top: 0; left: 0; display: none;";this.imageSet.appendChild(g);this.imageSet.frames.push(g)}this.element.appendChild(this.imageSet);if(Lenticular.images.length==1&&this.useTilt){Lenticular.updateOrientation();window.addEventListener("orientationchange",Lenticular.updateOrientation,false);window.addEventListener("deviceorientation",Lenticular.updateFrames,false)}};Lenticular.Image.prototype.showFrame=function(b){if(this.lastFrame){this.lastFrame.style.display="none"}var a=this.imageSet.frames[b];a.style.display="block";this.lastFrame=a};Lenticular.Image.prototype.activate=function(){this.isActive=true};Lenticular.Image.prototype.deactivate=function(){this.isActive=false};Lenticular.Image.prototype.destroy=function(){Lenticular.images.splice(Lenticular.images.indexOf(this),1);if(Lenticular.images.length==0&&this.useTilt){window.removeEventListener("orientationchange",Lenticular.updateOrientation);window.removeEventListener("deviceorientation",Lenticular.updateFrames)}};