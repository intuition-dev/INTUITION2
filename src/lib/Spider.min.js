// mB v6.06.07 on 2019-06-11T16:59:39.367Z
"use strict"
Object.defineProperty(exports,"__esModule",{value:!0})
var FileOpsBase_1=require("./FileOpsBase"),probe=require("probe-image-size"),extractor=require("unfluff"),axios_1=require("axios"),logger=require("tracer").console(),sm=require("sitemap"),traverse=require("traverse"),lunr=require("lunr"),yaml=require("js-yaml"),fs=require("fs-extra"),FileHound=require("filehound"),Map=function(){function Map(e){!e||e.length<1||(this._root=e)}return Map.prototype.gen=function(){return new Promise(function(e,r){var t=yaml.load(fs.readFileSync(this._root+"/map.yaml")),i=JSON.stringify(t.menu,null,2)
fs.writeFileSync(this._root+"/menu.json",i),this._sitemap=sm.createSitemap({hostname:t.host})
var a=traverse(t.menu).reduce(function(e,r){return this.isLeaf&&e.push(r),e},[]),o=t.itemsRoot
if(o){var n=new FileOpsBase_1.Dirs(this._root+o)
a=a.concat(n.getFolders())}var s=a.length
logger.info(s)
for(var c=0;c<s;c++)try{var l=a[c]
l.includes(this._root)&&(l=l.replace(this._root,""))
var u=this._root+l,p=new FileOpsBase_1.Dat(u).getAll()
logger.info(l)
var f=p.priority
f||(f=.3)
var h=p.image
h?this._sitemap.add({url:l,changefreq:t.changefreq,priority:f,img:[{url:h,title:p.title,caption:p.title}]}):this._sitemap.add({url:l,changefreq:t.changefreq,priority:f})}catch(e){logger.info(e)}var g=this
this._sitemap.toXML(function(e,r){fs.writeFileSync(g._root+"/sitemap.xml",r),g._map(a)}),e("OK")})},Map.prototype._map=function(e){for(var r=[],t=e.length,i=0;i<t;i++)try{var a=e[i]
a.includes(this._root)&&(a=a.replace(this._root,""))
for(var o=this._root+a,n=FileHound.create().paths(o).ext("md").findSync(),s="",c=0,l=n;c<l.length;c++){var u=l[c]
u=FileOpsBase_1.Dirs.slash(u),s=s+" "+fs.readFileSync(u,"utf8")}var p={id:a,body:s}
r.push(p)}catch(e){logger.info(e)}logger.info(r.length)
var f=lunr(function(){this.ref("id"),this.field("body"),r.forEach(function(e){this.add(e)},this)}),h=JSON.stringify(f)
fs.writeFileSync(this._root+"/FTS.idx",h)},Map}()
exports.Map=Map
var Scrape=function(){function Scrape(){axios_1.default.defaults.responseType="document"}return Scrape.prototype.s=function(e){return new Promise(function(r,t){try{axios_1.default.get(e).then(function(e){var t=extractor.lazy(e.data),i=new Object
i.title=t.softTitle(),i.content_text=t.description(),i.image=t.image(),i.title=Scrape.alphaNumeric(i.title),i.content_text=Scrape.alphaNumeric(i.content_text),r(i)})}catch(e){logger.warn(e),t(e)}})},Scrape.__getImageSize=function(e){return logger.info(e),probe(e,{timeout:3e3})},Scrape.alphaNumeric=function(e){if(!e)return""
for(var r=Array.from("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 "),t="",i=0;i<e.length;i++){var a=e[i],o=r.indexOf(a)
o>-1&&(t+=r[o])}return t},Scrape}()
exports.Scrape=Scrape,module.exports={Scrape:Scrape}