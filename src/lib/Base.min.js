// mB v6.06.07 on 2019-06-11T16:59:39.367Z
"use strict"
var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var r,t=1,i=arguments.length;t<i;t++)for(var n in r=arguments[t])Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])
return e}).apply(this,arguments)},__awaiter=this&&this.__awaiter||function(e,r,t,i){return new(t||(t=Promise))(function(n,s){function fulfilled(e){try{step(i.next(e))}catch(e){s(e)}}function rejected(e){try{step(i.throw(e))}catch(e){s(e)}}function step(e){e.done?n(e.value):new t(function(r){r(e.value)}).then(fulfilled,rejected)}step((i=i.apply(e,r||[])).next())})},__generator=this&&this.__generator||function(e,r){var t,i,n,s,o={label:0,sent:function(){if(1&n[0])throw n[1]
return n[1]},trys:[],ops:[]}
return s={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s
function verb(e){return function(r){return step([e,r])}}function step(s){if(t)throw new TypeError("Generator is already executing.")
for(;o;)try{if(t=1,i&&(n=2&s[0]?i.return:s[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,s[1])).done)return n
switch(i=0,n&&(s=[2&s[0],n.value]),s[0]){case 0:case 1:n=s
break
case 4:return o.label++,{value:s[1],done:!1}
case 5:o.label++,i=s[1],s=[0]
continue
case 7:s=o.ops.pop(),o.trys.pop()
continue
default:if(!(n=(n=o.trys).length>0&&n[n.length-1])&&(6===s[0]||2===s[0])){o=0
continue}if(3===s[0]&&(!n||s[1]>n[0]&&s[1]<n[3])){o.label=s[1]
break}if(6===s[0]&&o.label<n[1]){o.label=n[1],n=s
break}if(n&&o.label<n[2]){o.label=n[2],o.ops.push(s)
break}n[2]&&o.ops.pop(),o.trys.pop()
continue}s=r.call(e,o)}catch(e){s=[6,e],i=0}finally{t=n=0}if(5&s[0])throw s[1]
return{value:s[0]?s[1]:void 0,done:!0}}}
Object.defineProperty(exports,"__esModule",{value:!0})
var Ver=function(){function Ver(){}return Ver.ver=function(){return"v6.06.07"},Ver.date=function(){return(new Date).toISOString()},Ver}()
exports.Ver=Ver
var colors=require("colors"),logger=require("tracer").colorConsole({filters:[{warn:colors.yellow,error:[colors.red]}]}),Extra_1=require("./Extra"),FileOpsBase_1=require("./FileOpsBase"),Marpit=require("@marp-team/marpit"),marpit=new Marpit.Marpit,fs=require("fs-extra"),FileHound=require("filehound"),yaml=require("js-yaml"),findUp=require("find-up"),riotc=require("riot-compiler"),pug=require("pug"),minify=require("html-minifier").minify,Terser=require("terser"),beeper=require("beeper"),JavaScriptObfuscator=require("javascript-obfuscator"),markdownItCont=require("markdown-it-container"),md=require("markdown-it")({html:!0,typographer:!0,linkify:!0})
md.use(markdownItCont,"dynamic",{validate:function(){return!0},render:function(e,r){var t=e[r]
return 1===t.nesting?'\n<div class="'+t.info.trim()+'">':"</div>\n"}})
var MBake=function(){function MBake(){}return MBake.prototype.bake=function(e,r){return new Promise(function(t,i){(!e||e.length<1)&&i("no path_ arg passed")
try{var n=new FileOpsBase_1.Dirs(e),s=n.getFolders();(!s||s.length<1)&&(e=FileOpsBase_1.Dirs.goUpOne(e),s=(n=new FileOpsBase_1.Dirs(e)).getFolders())
for(var o=0,a=s;o<a.length;o++){var l=a[o]
new BakeWrk(l).bake(r)}t("OK")}catch(e){logger.info(e),i(e)}})},MBake.prototype.compsNBake=function(e,r){var t=this
return new Promise(function(i,n){return __awaiter(this,void 0,void 0,function(){var s,o,a
return __generator(this,function(l){switch(l.label){case 0:(!e||e.length<1)&&n("no path args passed"),l.label=1
case 1:return l.trys.push([1,3,,4]),s=new Comps(e),o=s.get(),[4,s.comps(o)]
case 2:return l.sent(),t.bake(e,r).then(function(){i("OK")}).catch(function(e){logger.info(e),n(e)}),[3,4]
case 3:return a=l.sent(),logger.info(a),n(a),[3,4]
case 4:return[2]}})})})},MBake.prototype.clearToProd=function(e){return new Promise(function(r,t){(!e||e.length<1)&&t("no path_ arg passed")
try{var i=FileOpsBase_1.Dirs.slash(e)
FileHound.create().paths(i).ext(["pug","yaml","js","ts","scss"]).findSync().forEach(function(e){"min"===e.split(".")[e.split(".").length-2]||fs.removeSync(e)})}catch(e){logger.warn(e),t(e)}r("OK")})},MBake.prototype.itemizeNBake=function(e,r){var t=this
return new Promise(function(i,n){(!e||e.length<1)&&n("no path arg passed"),logger.info("ib:",e)
try{new Items(e).itemize()}catch(e){logger.info(e),n(e)}t.bake(e,r).then(function(){i("OK")}).catch(function(e){logger.info(e),n(e)})})},MBake}()
exports.MBake=MBake
var BakeWrk=function(){function BakeWrk(e){var r=FileOpsBase_1.Dirs.slash(e)
this.dir=r}return BakeWrk.metaMD=function(e,r){return md.render(e)},BakeWrk.marp=function(e,r){var t=marpit.render(e),i=t.html
t.css
return i},BakeWrk.minify_pg=function(e,r){var t=e.match(/^\s*\s*$/)?"":e,i=Object.assign({},Extra_1.MinJS.CompOptionsJS)
i.output={indent_level:0,quote_style:3,semicolons:!1}
var n=Terser.minify(t,i)
return n.error?(beeper(),e):n.code.replace(/;$/,"")},BakeWrk.sindexes=function(e,r){if(!e)return[]
if(!r)return[]
for(var t=[],i=0;i<e.length;++i)e.substring(i,i+r.length)==r&&t.push(i)
return t},BakeWrk.prototype.bake=function(e){var r=this.dir+"/index.pug"
if(fs.existsSync(r)){process.chdir(this.dir)
var t=new FileOpsBase_1.Dat(this.dir).getAll()
if(t.filters={metaMD:BakeWrk.metaMD,marp:BakeWrk.marp},t.ENV=e,this.locAll(t))return" "
if(this.writeFilePg(this.dir+"/index.pug",t,this.dir+"/index.html"),!fs.existsSync(this.dir+"/m.pug"))return" "
this.writeFilePg(this.dir+"/m.pug",t,this.dir+"/m.html")}},BakeWrk.prototype.locAll=function(e){if(!e.LOC)return!1
var r,t=e.LOC,i=(t=this.dir+t)+"/loc.yaml"
if(fs.existsSync(i))r=yaml.load(fs.readFileSync(i))
else{var n=findUp.sync("loc.yaml",{cwd:t})
r=yaml.load(fs.readFileSync(n)),t=n.slice(0,-8)}var s=r.loc,o=new Set(s)
logger.info(o)
for(var a=__assign({},r,e),l=0,c=o;l<c.length;l++){var u=c[l]
this.do1Locale(u,a)}fs.remove(this.dir+"/index.html")},BakeWrk.prototype.do1Locale=function(e,r){var t={}
for(var i in t.LOCALE=e,r)if(i.endsWith("-"+e)){var n=i.length-("-"+e).length
t[i.substring(0,n)]=r[i]}var s=__assign({},r,t),o=this.dir+"/"+e
if(fs.ensureDirSync(o),fs.existsSync(o+"/loc.pug")?this.writeFilePg(o+"/loc.pug",s,o+"/index.html"):this.writeFilePg(this.dir+"/index.pug",s,o+"/index.html"),!fs.existsSync(this.dir+"/m.pug"))return" "
this.writeFilePg(this.dir+"/m.pug",s,o+"/m.html")},BakeWrk.prototype.writeFilePg=function(e,r,t){var i=pug.renderFile(e,r),n="\x3c!-- mB "+Ver.ver()+" on "+Ver.date()+" --\x3e"
r.pretty||(i=minify(i,BakeWrk.minifyPg)),i=i.replace(BakeWrk.ebodyHtml,n+BakeWrk.ebodyHtml),fs.writeFileSync(t,i)},BakeWrk.ebodyHtml="</body>",BakeWrk.minifyPg={caseSensitive:!0,collapseWhitespace:!0,decodeEntities:!0,minifyCSS:!0,minifyJS:BakeWrk.minify_pg,quoteCharacter:"'",removeComments:!0,removeScriptTypeAttributes:!0,removeStyleLinkTypeAttributes:!0,useShortDoctype:!0,sortAttributes:!0,sortClassName:!0},BakeWrk}()
exports.BakeWrk=BakeWrk
var Items=function(){function Items(e){var r=FileOpsBase_1.Dirs.slash(e),t=r+"/dat_i.yaml"
if(!fs.existsSync(t)){var i=findUp.sync("dat_i.yaml",{cwd:r})
null!=i&&(r=i.slice(0,-11))}this.dir=r
var n=new FileOpsBase_1.Dirs(r)
this.dirs=n.getFolders()}return Items.prototype._addAnItem=function(e){try{if(!fs.existsSync(e+"/dat.yaml"))return
var r=yaml.load(fs.readFileSync(e+"/dat.yaml"))
if(!r)return
if(0==r.publish)return
if(void 0!==r.publishDate&&null!==r.publishDate&&r.publishDate-Date.now()>0)return
Items.clean(r)
var t=e.lastIndexOf("/"),i=e.substring(t+1)
r.url=i,r.hasOwnProperty("id")||(r.id=i),this.feed.items||(this.feed.items=[]),r.index=this.feed.items.length,this.feed.items.push(r)}catch(e){logger.info(e)}},Items.prototype.itemize=function(){logger.info("Itemizing: "+this.dir)
var e=this.dir,r=e+"/dat_i.yaml"
if(fs.existsSync(r)){var t=yaml.load(fs.readFileSync(r))
Items.clean(t),t.mbVer=Ver.ver(),this.feed=t,logger.warn(this.feed)
for(var i=0,n=this.dirs;i<n.length;i++){var s=n[i]
this._addAnItem(s)}if(this.feed.items||(this.feed.items=[]),0!=this.feed.items.length){this.feed.count=this.feed.items.length
var o=JSON.stringify(this.feed,null,2),a=e+"/items.json"
return fs.writeFileSync(a,o)," processed "}logger.info("no items")}},Items.clean=function(e){delete e.basedir,delete e.ROOT,delete e.pretty,delete e.LOC,delete e.publishFlag},Items}()
exports.Items=Items
var Comps=function(){function Comps(e){this.ver="// mB "+Ver.ver()+" on "+Ver.date()+"\r\n"
var r=FileOpsBase_1.Dirs.slash(e)
this.dir=r}return Comps.prototype.get=function(){for(var e=[],r=0,t=FileHound.create().paths(this.dir).ext("pug").glob("*-comp.pug").findSync();r<t.length;r++){var i=t[r]
i=i.split("\\").join("/"),e.push(i)}return e},Comps.prototype.comps=function(e){var r=this
return new Promise(function(t,i){return __awaiter(this,void 0,void 0,function(){var i,n,s,o,a,l,c,u
return __generator(this,function(f){switch(f.label){case 0:i=0,n=e,f.label=1
case 1:return i<n.length?(s=n[i],o=fs.readFileSync(s).toString(),a=s.lastIndexOf("/"),l=s.substring(0,a),c=s.substring(a),u=c.lastIndexOf("."),c=c.substring(0,u),[4,r.process(o,l,l+c)]):[3,4]
case 2:f.sent(),f.label=3
case 3:return i++,[3,1]
case 4:return t("OK"),[2]}})})})},Comps.prototype.process=function(e,r,t){var i=this
return new Promise(function(n,s){var o,a={template:"pug",basedir:r}
logger.info("compiling",t)
try{o=riotc.compile(e,a,t)}catch(e){beeper(1),logger.error("compiler error"),logger.error(e),s(e)}fs.writeFileSync(t+".js",o)
var l=Object.assign({},Extra_1.MinJS.CompOptionsJS)
l.output={indent_level:0,quote_style:0,semicolons:!1}
var c,u=Terser.minify(o,l)
try{logger.info("obs"),c=JavaScriptObfuscator.obfuscate(u.code,Extra_1.MinJS.getCompOptions())}catch(e){logger.error("error"),logger.error(e),s(e)}var f=i.ver+c.getObfuscatedCode()
fs.writeFileSync(t+".min.js",f),n("OK")})},Comps}()
exports.Comps=Comps,module.exports={BakeWrk:BakeWrk,Items:Items,Comps:Comps,Ver:Ver,MBake:MBake}