// mB v6.06.07 on 2019-06-11T16:59:39.367Z
"use strict"
var __awaiter=this&&this.__awaiter||function(e,r,t,n){return new(t||(t=Promise))(function(s,i){function fulfilled(e){try{step(n.next(e))}catch(e){i(e)}}function rejected(e){try{step(n.throw(e))}catch(e){i(e)}}function step(e){e.done?s(e.value):new t(function(r){r(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,r||[])).next())})},__generator=this&&this.__generator||function(e,r){var t,n,s,i,o={label:0,sent:function(){if(1&s[0])throw s[1]
return s[1]},trys:[],ops:[]}
return i={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i
function verb(e){return function(r){return step([e,r])}}function step(i){if(t)throw new TypeError("Generator is already executing.")
for(;o;)try{if(t=1,n&&(s=2&i[0]?n.return:i[0]?n.throw||((s=n.return)&&s.call(n),0):n.next)&&!(s=s.call(n,i[1])).done)return s
switch(n=0,s&&(i=[2&i[0],s.value]),i[0]){case 0:case 1:s=i
break
case 4:return o.label++,{value:i[1],done:!1}
case 5:o.label++,n=i[1],i=[0]
continue
case 7:i=o.ops.pop(),o.trys.pop()
continue
default:if(!(s=(s=o.trys).length>0&&s[s.length-1])&&(6===i[0]||2===i[0])){o=0
continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){o.label=i[1]
break}if(6===i[0]&&o.label<s[1]){o.label=s[1],s=i
break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(i)
break}s[2]&&o.ops.pop(),o.trys.pop()
continue}i=r.call(e,o)}catch(e){i=[6,e],n=0}finally{t=s=0}if(5&i[0])throw i[1]
return{value:i[0]?i[1]:void 0,done:!0}}}
Object.defineProperty(exports,"__esModule",{value:!0})
var Base_1=require("./Base"),yaml=require("js-yaml"),findUp=require("find-up"),sass=require("node-sass"),autoprefixer=require("autoprefixer"),postcss=require("postcss"),stripCssComments=require("strip-css-comments"),path=require("path"),fs=require("fs-extra"),FileHound=require("filehound"),logger=require("tracer").console(),JavaScriptObfuscator=require("javascript-obfuscator"),ts=require("typescript"),Terser=require("terser"),MinJS=function(){function MinJS(){}return MinJS.prototype.ts=function(e){logger.info(e)
var r=this
return new Promise(function(t,n){var s=FileHound.create().paths(e).ext("ts").findSync()
s.length<1&&t("OK"),r.compile(s,{target:ts.ScriptTarget.ES5,removeComments:!0}),t("OK")})},MinJS.prototype.min=function(e){var r=this
return new Promise(function(t,n){return __awaiter(this,void 0,void 0,function(){var s,i,o,a,c
return __generator(this,function(l){switch(l.label){case 0:s=FileHound.create().paths(e).ext("js").addFilter(function(e){return!e._pathname.endsWith(".min.js")&&!e._pathname.endsWith("-comp.js")}).findSync(),i=0,o=s,l.label=1
case 1:if(!(i<o.length))return[3,6]
a=o[i],l.label=2
case 2:return l.trys.push([2,4,,5]),[4,r._minOneJS(a)]
case 3:return l.sent(),[3,5]
case 4:return c=l.sent(),logger.warn(c),n(c),[3,5]
case 5:return i++,[3,1]
case 6:return t("OK"),[2]}})})})},MinJS.prototype._minOneJS=function(e){return new Promise(function(r,t){return __awaiter(this,void 0,void 0,function(){var n,s,i,o,a,c,l
return __generator(this,function(u){try{if(s=fs.readFileSync(e).toString("utf8"),i=Object.assign({},MinJS.CompOptionsJS),o={indent_level:0,quote_style:0,semicolons:!1},i.output=o,n=e.includes("-wcomp")?Terser.minify(s,MinJS.CompOptionsJS):Terser.minify(s,i),a=(a=(a=(a=n.code).replace(/(\r\n\t|\n|\r\t)/gm,"\n")).replace(/\n\s*\n/g,"\n")).trim(),e.includes("-wcomp")){c=void 0
try{logger.info("obs"),c=JavaScriptObfuscator.obfuscate(a,MinJS.getCompOptions()),a=c.getObfuscatedCode()}catch(e){logger.error("error"),logger.error(e),t(e)}}a=MinJS.ver+a,l=e.slice(0,-3),l+=".min.js",fs.writeFileSync(l,a),r("OK")}catch(e){logger.warn(e,n),t(e)}return[2]})})})},MinJS.getCompOptions=function(){return{identifierNamesGenerator:"hexadecimal",disableConsoleOutput:!1,target:"browser",stringArray:!0,stringArrayThreshold:1,stringArrayEncoding:"rc4",selfDefending:!1,controlFlowFlattening:!0,controlFlowFlatteningThreshold:.6,deadCodeInjection:!1}},MinJS.prototype.compile=function(e,r){var t=ts.createProgram(e,r),n=t.emit()
ts.getPreEmitDiagnostics(t).concat(n.diagnostics).forEach(function(e){if(e.file){var r=e.file.getLineAndCharacterOfPosition(e.start)
r.line,r.character,ts.flattenDiagnosticMessageText(e.messageText,"\n")}})
n.emitSkipped},MinJS.ver="// mB "+Base_1.Ver.ver()+" on "+Base_1.Ver.date()+"\r\n",MinJS.CompOptionsJS={parse:{html5_comments:!1},compress:{drop_console:!0,keep_fargs:!0,reduce_funcs:!1},output:{indent_level:1,quote_style:3,semicolons:!1},ecma:5,keep_classnames:!0,keep_fnames:!0},MinJS}()
exports.MinJS=MinJS
var Sas=function(){function Sas(){}return Sas.prototype.css=function(e){var r=this
return new Promise(function(t,n){return __awaiter(this,void 0,void 0,function(){var n,s,i,o,a,c,l,u
return __generator(this,function(p){switch(p.label){case 0:s=e+"/assets.yaml",fs.existsSync(s)?n=yaml.load(fs.readFileSync(s)):(i=findUp.sync("assets.yaml",{cwd:e}),n=yaml.load(fs.readFileSync(i)),e=i.slice(0,-12)),logger.info(e),o=n.css,a=new Set(o),logger.info(a),c=0,l=a,p.label=1
case 1:return c<l.length?(u=l[c],[4,r._trans(u,e)]):[3,4]
case 2:p.sent(),p.label=3
case 3:return c++,[3,1]
case 4:return t("OK"),[2]}})})})},Sas.prototype._trans=function(e,r){var t=sass.renderSync({file:r+"/"+e,outputStyle:"compact"})
postcss([autoprefixer({browsers:["> 0.5%","cover 99.5%","last 2 major versions","Firefox ESR","ios_saf >= 10","ie >= 11"]})]).process(t.css,{from:void 0}).then(function(t){t.warnings().forEach(function(e){})
var n=stripCssComments(t.css,{preserve:!1})
n=(n=(n=(n=(n=(n=(n=(n=(n=n.replace(/(\r\n\t|\n|\r\t)/gm,"\n")).replace(/\n\s*\n/g,"\n")).trim()).replace(/  /g," ")).replace(/; /g,";")).replace(/: /g,":")).replace(/ }/g,"}")).replace(/ { /g,"{")).replace(/, /g,","),n+=" /* mB "+Base_1.Ver.ver()+" on "+Base_1.Ver.date()+" */"
var s=path.basename(e),i=(s=s.split(".").slice(0,-1).join(".")).split("\\").pop().split("/").pop()
fs.ensureDirSync(r+"/css"),fs.writeFileSync(r+"/css/"+i+".css",n)})},Sas}()
exports.Sas=Sas,module.exports={Sas:Sas,MinJS:MinJS}