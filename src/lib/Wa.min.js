// mB v6.06.07 on 2019-06-11T16:59:39.367Z
"use strict"
var __awaiter=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(o,s){function fulfilled(e){try{step(n.next(e))}catch(e){s(e)}}function rejected(e){try{step(n.throw(e))}catch(e){s(e)}}function step(e){e.done?o(e.value):new r(function(t){t(e.value)}).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){var r,n,o,s,a={label:0,sent:function(){if(1&o[0])throw o[1]
return o[1]},trys:[],ops:[]}
return s={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s
function verb(e){return function(t){return step([e,t])}}function step(s){if(r)throw new TypeError("Generator is already executing.")
for(;a;)try{if(r=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o
switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s
break
case 4:return a.label++,{value:s[1],done:!1}
case 5:a.label++,n=s[1],s=[0]
continue
case 7:s=a.ops.pop(),a.trys.pop()
continue
default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===s[0]||2===s[0])){a=0
continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1]
break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s
break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s)
break}o[2]&&a.ops.pop(),a.trys.pop()
continue}s=t.call(e,a)}catch(e){s=[6,e],n=0}finally{r=o=0}if(5&s[0])throw s[1]
return{value:s[0]?s[1]:void 0,done:!0}}}
Object.defineProperty(exports,"__esModule",{value:!0})
var Base_1=require("./Base"),Extra_1=require("./Extra"),FileOpsBase_1=require("./FileOpsBase"),express=require("express"),chokidar=require("chokidar"),reload=require("reload"),cheerio=require("cheerio"),interceptor=require("express-interceptor"),logger=require("tracer").console(),opn=require("open"),Wa=function(){function Wa(){}return Wa.watch=function(e,t,r){new MDevSrv(e,t=t||8090,r)
var n=new MetaPro(e)
new Watch(n,e).start(450),opn("http://localhost:"+t)},Wa}()
exports.Wa=Wa
var Watch=function(){function Watch(e,t){this.mp=e,t.endsWith("/.")&&(t=t.slice(0,-1)),this.root=t}return Watch.prototype.start=function(e){this.delay=e
var t=[]
t.push(this.root+"/**/*.md"),t.push(this.root+"/**/*.ts"),t.push(this.root+"/**/*.pug"),t.push(this.root+"/**/*.scss"),t.push(this.root+"/**/*.sass"),t.push(this.root+"/**/*.yaml"),t.push(this.root+"/**/*.js"),t.push(this.root+"/**/*.json"),logger.trace(t),this.watcher=chokidar.watch(t,{ignoreInitial:!0,cwd:this.root,usePolling:!0,useFsEvents:!1,binaryInterval:5*e,interval:e,atomic:e,awaitWriteFinish:{stabilityThreshold:1.2*e,pollInterval:.5*e}})
var r=this
this.watcher.on("add",function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,r.autoNT(e,"a")]
case 1:return t.sent(),[2]}})})}),this.watcher.on("change",function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,r.autoNT(e,"c")]
case 1:return t.sent(),[2]}})})})},Watch.prototype.refreshBro=function(){MDevSrv.reloadServer.reload()},Watch.prototype.autoNT=function(e,t){return __awaiter(this,void 0,void 0,function(){var t,r,n,o,s
return __generator(this,function(a){switch(a.label){case 0:t=FileOpsBase_1.Dirs.slash(e),r=t.lastIndexOf("/"),n="",o=t,r>0&&(n=t.substring(0,r),o=t.substr(r+1)),a.label=1
case 1:return a.trys.push([1,4,,5]),logger.info("WATCHED1:",n+"/"+o),[4,this.mp.autoBake(n,o)]
case 2:return a.sent(),[4,this.refreshBro()]
case 3:return a.sent(),[3,5]
case 4:return s=a.sent(),logger.warn(s),[3,5]
case 5:return[2]}})})},Watch}()
exports.Watch=Watch
var MetaPro=function(){function MetaPro(e){this.b=new Base_1.MBake,this.mount=e,logger.info("MetaPro",this.mount)}return MetaPro.prototype.bake=function(e){var t=this.mount+"/"+e
return logger.info(t),this.b.bake(t,0)},MetaPro.prototype.comps=function(e){var t=this.mount+"/"+e
return logger.info(t),this.b.compsNBake(t,0)},MetaPro.prototype.itemize=function(e){return this.b.itemizeNBake(this.mount+"/"+e,0)},MetaPro.prototype.css=function(e){return(new Extra_1.Sas).css(this.mount+"/"+e)},MetaPro.prototype.ts=function(e){var t=this.mount+"/"+e
return(new Extra_1.MinJS).ts(t)},MetaPro.prototype.autoBake=function(e,t){return __awaiter(this,void 0,void 0,function(){var r,n
return __generator(this,function(o){switch(o.label){case 0:return r=FileOpsBase_1.Dirs.slash(e),n=t.split(".").pop(),logger.info("WATCHED2:",r,n),"scss"!=n&&"sass"!=n?[3,2]:[4,this.css(r)]
case 1:return[2,o.sent()]
case 2:return"ts"!=n?[3,4]:[4,this.ts(r)]
case 3:return[2,o.sent()]
case 4:return"yaml"!=n?[3,6]:[4,this.itemize(r)]
case 5:return[2,o.sent()]
case 6:return"md"!=n?[3,8]:[4,this.bake(r)]
case 7:return[2,o.sent()]
case 8:return"pug"!=n?[3,12]:t.indexOf("-comp")>=0?[4,this.comps(r)]:[3,10]
case 9:return[2,o.sent()]
case 10:return[4,this.bake(r)]
case 11:return[2,o.sent()]
case 12:return[2,"Cant process "+n]}})})},MetaPro.folderProp="folder",MetaPro.srcProp="src",MetaPro.destProp="dest",MetaPro}()
exports.MetaPro=MetaPro
var MDevSrv=function(){return function MDevSrv(e,t,r){var n=express()
logger.info(e,t),n.set("app port",t)
var o=Number(r)||9856
reload(n,{verbose:!1,port:o}).then(function(e){MDevSrv.reloadServer=e,logger.info("reloadServer")}).catch(function(e){}),n.set("views",e)
var s=interceptor(function(e,t){return{isInterceptable:function(){return/text\/html/.test(t.get("Content-Type"))},intercept:function(e,t){var r=cheerio.load(e)
r("body").prepend('<script src="/reload/reload.js"><\/script>'),t(r.html())}}}),a=interceptor(function(e,t){return{isInterceptable:function(){var e=/application\/javascript/.test(t.get("Content-Type")),r=/text\/css/.test(t.get("Content-Type")),n=/image\/jpg/.test(t.get("Content-Type"))
return r||e||n},intercept:function(e,t){setTimeout(function(){t(e)},Math.floor(200*Math.random())+50)}}})
n.use(s),n.use(a),n.use(express.static(e)),n.listen(t,function(){logger.info("dev srv "+t)})}}()
exports.MDevSrv=MDevSrv,module.exports={Wa:Wa,MetaPro:MetaPro,Watch:Watch,MDevSrv:MDevSrv}